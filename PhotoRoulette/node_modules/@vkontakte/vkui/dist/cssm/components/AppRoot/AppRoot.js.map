{"version":3,"sources":["../../../../src/components/AppRoot/AppRoot.tsx"],"sourcesContent":["import * as React from 'react';\nimport { classNames } from '@vkontakte/vkjs';\nimport { useAdaptivity } from '../../hooks/useAdaptivity';\nimport { useKeyboardInputTracker } from '../../hooks/useKeyboardInputTracker';\nimport { useObjectMemo } from '../../hooks/useObjectMemo';\nimport { getDocumentBody } from '../../lib/dom';\nimport { useTokensClassName } from '../../lib/tokens';\nimport { useIsomorphicLayoutEffect } from '../../lib/useIsomorphicLayoutEffect';\nimport { useConfigProvider } from '../ConfigProvider/ConfigProviderContext';\nimport { AppRootContext } from './AppRootContext';\nimport { ElementScrollController, GlobalScrollController } from './ScrollContext';\nimport {\n  extractPortalRootByProp,\n  getClassNamesByMode,\n  getParentElement,\n  getUserSelectModeClassName,\n  setSafeAreaInsets,\n} from './helpers';\nimport type {\n  AppRootLayout,\n  AppRootMode,\n  AppRootScroll,\n  AppRootUserSelectMode,\n  SafeAreaInsets,\n} from './types';\nimport styles from './AppRoot.module.css';\n\nexport interface AppRootProps extends React.HTMLAttributes<HTMLDivElement> {\n  /** Режим встраивания */\n  mode?: AppRootMode;\n  /**\n   * - `global` (по умолчанию) — VKUI-приложение скроллится вместе со страницей.\n   * - `contain` — VKUI-приложение живет в отдельной зоне и скроллится независимо внутри `AppRoot` (например, в модалке).\n   *\n   * Полезно при использовании `mode=\"embedded\"`.\n   */\n  scroll?: AppRootScroll;\n  /**\n   * см. документацию [mdn web docs | env#values](https://developer.mozilla.org/en-US/docs/Web/CSS/env#values).\n   */\n  safeAreaInsets?: SafeAreaInsets;\n  /**\n   * Кастомный root-элемент портала\n   */\n  portalRoot?: HTMLElement | React.RefObject<HTMLElement> | null;\n  /**\n   * Отключает рендер всплывающих компонентов в отдельном контейнере\n   */\n  disablePortal?: boolean;\n  /**\n   * По умолчанию, mode=\"embedded\" переносит систему координат элементов с `position: fixed` на\n   * свой контейнер через `transform: translate3d(0, 0, 0)`.\n   *\n   * Это поведение можно отключить с помощью этого параметра.\n   */\n  disableParentTransformForPositionFixedElements?: boolean;\n  /**\n   * Глобально задаёт тип оформления макета для компонентов\n   * [Panel](https://vkcom.github.io/VKUI/#/Panel) и [Group](https://vkcom.github.io/VKUI/#/Group).\n   */\n  layout?: AppRootLayout;\n  /**\n   * Задаёт режим выбора текста (выделения текста) для всего приложения.\n   * По умолчанию, если режим не задан, запрещает выбор текста в приложениях,\n   * запущенных в webview (по значению свойства `isWebView` из [ConfigProvider](https://vkcom.github.io/VKUI/#/ConfigProvider)).\n   *\n   * - `enabled-with-pointer` – разрешает выбор текста, если устройство ввода типа `pointer` (например, `мышь`), в остальных случаях запрещает;\n   * - `disabled` – запрещает выбор текста;\n   * - `enabled` – разрешает выбор текста.\n   *\n   * @since 6.2.0\n   */\n  userSelectMode?: AppRootUserSelectMode;\n}\n\n/**\n * @see https://vkcom.github.io/VKUI/#/AppRoot\n */\nexport const AppRoot = ({\n  children,\n  mode = 'full',\n  scroll = 'global',\n  portalRoot: portalRootProp = null,\n  disablePortal = false,\n  disableParentTransformForPositionFixedElements,\n  className,\n  safeAreaInsets: safeAreaInsetsProp,\n  layout,\n  userSelectMode,\n  ...props\n}: AppRootProps): React.ReactNode => {\n  const { hasPointer, sizeX = 'none', sizeY = 'none' } = useAdaptivity();\n  const tokensClassName = useTokensClassName();\n\n  const safeAreaInsets = useObjectMemo(safeAreaInsetsProp);\n  const isKeyboardInputActiveRef = useKeyboardInputTracker();\n  const appRootRef = React.useRef<HTMLDivElement | null>(null);\n  const portalRootRef = React.useRef<HTMLElement | null>(null);\n\n  useIsomorphicLayoutEffect(\n    function setupPortalRoot() {\n      const portalByProp = portalRootProp ? extractPortalRootByProp(portalRootProp) : null;\n\n      if (portalByProp) {\n        portalRootRef.current = portalByProp;\n        return function cleanup() {\n          portalRootRef.current = null;\n        };\n      }\n\n      const documentBody = getDocumentBody(appRootRef.current);\n      const portal = documentBody.ownerDocument.createElement('div');\n      documentBody.appendChild(portal);\n      portalRootRef.current = portal;\n      return function cleanup() {\n        documentBody.removeChild(portal);\n        portalRootRef.current = null;\n      };\n    },\n    [portalRootProp],\n  );\n\n  useIsomorphicLayoutEffect(\n    function setupContainers() {\n      if (!appRootRef.current || !portalRootRef.current) {\n        return;\n      }\n\n      const parentElement = getParentElement(appRootRef.current);\n      const documentBody = getDocumentBody(appRootRef.current);\n      const documentElement = documentBody.ownerDocument.documentElement;\n\n      const [baseClassNames, stylesClassNames] = getClassNamesByMode({\n        mode,\n        layout,\n        tokensClassName,\n        sizeX,\n        sizeY,\n      });\n\n      /* eslint-disable no-restricted-properties */\n      switch (mode) {\n        case 'full': {\n          if (parentElement) {\n            parentElement.classList.add(...baseClassNames);\n          }\n\n          documentElement.classList.add(...stylesClassNames, 'vkui');\n          const unsetSafeAreaInsets = setSafeAreaInsets(safeAreaInsets, documentElement);\n\n          return function cleanup() {\n            if (parentElement) {\n              parentElement.classList.remove(...baseClassNames);\n            }\n\n            documentElement.classList.remove(...stylesClassNames, 'vkui');\n            unsetSafeAreaInsets();\n          };\n        }\n        case 'embedded': {\n          if (parentElement) {\n            parentElement.classList.add(...baseClassNames, ...stylesClassNames);\n            if (!disableParentTransformForPositionFixedElements) {\n              parentElement.style.setProperty('transform', 'translate3d(0, 0, 0)');\n            }\n            const unsetSafeAreaInsets = setSafeAreaInsets(safeAreaInsets, parentElement, portalRootRef.current); // prettier-ignore\n            return function cleanup() {\n              parentElement.classList.remove(...baseClassNames, ...stylesClassNames);\n              if (!disableParentTransformForPositionFixedElements) {\n                parentElement.style.removeProperty('transform');\n              }\n              unsetSafeAreaInsets();\n            };\n          }\n          /* istanbul ignore next: node.parentElement может быть null, но такой кейс в теории невозможен */\n          return;\n        }\n        /* istanbul ignore next: не покрывается за счёт теста на <AppRoot mode=\"partial\" /> */\n        case 'partial': {\n          return;\n        }\n      }\n      /* eslint-enable no-restricted-properties */\n    },\n    [\n      mode,\n      layout,\n      disableParentTransformForPositionFixedElements,\n      tokensClassName,\n      sizeX,\n      sizeY,\n      safeAreaInsets,\n    ],\n  );\n\n  const ScrollController = React.useMemo(\n    () => (scroll === 'contain' ? ElementScrollController : GlobalScrollController),\n    [scroll],\n  );\n\n  const content = (\n    <AppRootContext.Provider\n      value={{\n        appRoot: appRootRef,\n        portalRoot: portalRootRef,\n        embedded: mode === 'embedded',\n        mode,\n        disablePortal,\n        layout,\n        get keyboardInput() {\n          return isKeyboardInputActiveRef.current;\n        },\n      }}\n    >\n      <ScrollController elRef={appRootRef}>{children}</ScrollController>\n    </AppRootContext.Provider>\n  );\n\n  const { isWebView } = useConfigProvider();\n  const userSelectModeClassName = getUserSelectModeClassName({\n    userSelectMode,\n    isWebView,\n    hasPointer,\n  });\n\n  return mode === 'partial' ? (\n    content\n  ) : (\n    <div\n      ref={appRootRef}\n      className={classNames(styles['AppRoot'], userSelectModeClassName, className)}\n      {...props}\n    >\n      {content}\n    </div>\n  );\n};\n"],"names":["React","classNames","useAdaptivity","useKeyboardInputTracker","useObjectMemo","getDocumentBody","useTokensClassName","useIsomorphicLayoutEffect","useConfigProvider","AppRootContext","ElementScrollController","GlobalScrollController","extractPortalRootByProp","getClassNamesByMode","getParentElement","getUserSelectModeClassName","setSafeAreaInsets","styles","AppRoot","children","mode","scroll","portalRoot","portalRootProp","disablePortal","disableParentTransformForPositionFixedElements","className","safeAreaInsets","safeAreaInsetsProp","layout","userSelectMode","props","hasPointer","sizeX","sizeY","tokensClassName","isKeyboardInputActiveRef","appRootRef","useRef","portalRootRef","setupPortalRoot","portalByProp","current","cleanup","documentBody","portal","ownerDocument","createElement","appendChild","removeChild","setupContainers","parentElement","documentElement","baseClassNames","stylesClassNames","classList","add","unsetSafeAreaInsets","remove","style","setProperty","removeProperty","ScrollController","useMemo","content","Provider","value","appRoot","embedded","keyboardInput","elRef","isWebView","userSelectModeClassName","div","ref"],"mappings":";AAAA,YAAYA,WAAW,QAAQ;AAC/B,SAASC,UAAU,QAAQ,kBAAkB;AAC7C,SAASC,aAAa,QAAQ,4BAA4B;AAC1D,SAASC,uBAAuB,QAAQ,sCAAsC;AAC9E,SAASC,aAAa,QAAQ,4BAA4B;AAC1D,SAASC,eAAe,QAAQ,gBAAgB;AAChD,SAASC,kBAAkB,QAAQ,mBAAmB;AACtD,SAASC,yBAAyB,QAAQ,sCAAsC;AAChF,SAASC,iBAAiB,QAAQ,0CAA0C;AAC5E,SAASC,cAAc,QAAQ,mBAAmB;AAClD,SAASC,uBAAuB,EAAEC,sBAAsB,QAAQ,kBAAkB;AAClF,SACEC,uBAAuB,EACvBC,mBAAmB,EACnBC,gBAAgB,EAChBC,0BAA0B,EAC1BC,iBAAiB,QACZ,YAAY;AAQnB,OAAOC,YAAY,uBAAuB;AAkD1C;;CAEC,GACD,OAAO,MAAMC,UAAU,CAAC,EACtBC,QAAQ,EACRC,OAAO,MAAM,EACbC,SAAS,QAAQ,EACjBC,YAAYC,iBAAiB,IAAI,EACjCC,gBAAgB,KAAK,EACrBC,8CAA8C,EAC9CC,SAAS,EACTC,gBAAgBC,kBAAkB,EAClCC,MAAM,EACNC,cAAc,EACd,GAAGC,OACU;IACb,MAAM,EAAEC,UAAU,EAAEC,QAAQ,MAAM,EAAEC,QAAQ,MAAM,EAAE,GAAGhC;IACvD,MAAMiC,kBAAkB7B;IAExB,MAAMqB,iBAAiBvB,cAAcwB;IACrC,MAAMQ,2BAA2BjC;IACjC,MAAMkC,aAAarC,MAAMsC,MAAM,CAAwB;IACvD,MAAMC,gBAAgBvC,MAAMsC,MAAM,CAAqB;IAEvD/B,0BACE,SAASiC;QACP,MAAMC,eAAelB,iBAAiBX,wBAAwBW,kBAAkB;QAEhF,IAAIkB,cAAc;YAChBF,cAAcG,OAAO,GAAGD;YACxB,OAAO,SAASE;gBACdJ,cAAcG,OAAO,GAAG;YAC1B;QACF;QAEA,MAAME,eAAevC,gBAAgBgC,WAAWK,OAAO;QACvD,MAAMG,SAASD,aAAaE,aAAa,CAACC,aAAa,CAAC;QACxDH,aAAaI,WAAW,CAACH;QACzBN,cAAcG,OAAO,GAAGG;QACxB,OAAO,SAASF;YACdC,aAAaK,WAAW,CAACJ;YACzBN,cAAcG,OAAO,GAAG;QAC1B;IACF,GACA;QAACnB;KAAe;IAGlBhB,0BACE,SAAS2C;QACP,IAAI,CAACb,WAAWK,OAAO,IAAI,CAACH,cAAcG,OAAO,EAAE;YACjD;QACF;QAEA,MAAMS,gBAAgBrC,iBAAiBuB,WAAWK,OAAO;QACzD,MAAME,eAAevC,gBAAgBgC,WAAWK,OAAO;QACvD,MAAMU,kBAAkBR,aAAaE,aAAa,CAACM,eAAe;QAElE,MAAM,CAACC,gBAAgBC,iBAAiB,GAAGzC,oBAAoB;YAC7DO;YACAS;YACAM;YACAF;YACAC;QACF;QAEA,2CAA2C,GAC3C,OAAQd;YACN,KAAK;gBAAQ;oBACX,IAAI+B,eAAe;wBACjBA,cAAcI,SAAS,CAACC,GAAG,IAAIH;oBACjC;oBAEAD,gBAAgBG,SAAS,CAACC,GAAG,IAAIF,kBAAkB;oBACnD,MAAMG,sBAAsBzC,kBAAkBW,gBAAgByB;oBAE9D,OAAO,SAAST;wBACd,IAAIQ,eAAe;4BACjBA,cAAcI,SAAS,CAACG,MAAM,IAAIL;wBACpC;wBAEAD,gBAAgBG,SAAS,CAACG,MAAM,IAAIJ,kBAAkB;wBACtDG;oBACF;gBACF;YACA,KAAK;gBAAY;oBACf,IAAIN,eAAe;wBACjBA,cAAcI,SAAS,CAACC,GAAG,IAAIH,mBAAmBC;wBAClD,IAAI,CAAC7B,gDAAgD;4BACnD0B,cAAcQ,KAAK,CAACC,WAAW,CAAC,aAAa;wBAC/C;wBACA,MAAMH,sBAAsBzC,kBAAkBW,gBAAgBwB,eAAeZ,cAAcG,OAAO,GAAG,kBAAkB;wBACvH,OAAO,SAASC;4BACdQ,cAAcI,SAAS,CAACG,MAAM,IAAIL,mBAAmBC;4BACrD,IAAI,CAAC7B,gDAAgD;gCACnD0B,cAAcQ,KAAK,CAACE,cAAc,CAAC;4BACrC;4BACAJ;wBACF;oBACF;oBACA,+FAA+F,GAC/F;gBACF;YACA,oFAAoF,GACpF,KAAK;gBAAW;oBACd;gBACF;QACF;IACA,0CAA0C,GAC5C,GACA;QACErC;QACAS;QACAJ;QACAU;QACAF;QACAC;QACAP;KACD;IAGH,MAAMmC,mBAAmB9D,MAAM+D,OAAO,CACpC,IAAO1C,WAAW,YAAYX,0BAA0BC,wBACxD;QAACU;KAAO;IAGV,MAAM2C,wBACJ,KAACvD,eAAewD,QAAQ;QACtBC,OAAO;YACLC,SAAS9B;YACTf,YAAYiB;YACZ6B,UAAUhD,SAAS;YACnBA;YACAI;YACAK;YACA,IAAIwC,iBAAgB;gBAClB,OAAOjC,yBAAyBM,OAAO;YACzC;QACF;kBAEA,cAAA,KAACoB;YAAiBQ,OAAOjC;sBAAalB;;;IAI1C,MAAM,EAAEoD,SAAS,EAAE,GAAG/D;IACtB,MAAMgE,0BAA0BzD,2BAA2B;QACzDe;QACAyC;QACAvC;IACF;IAEA,OAAOZ,SAAS,YACd4C,wBAEA,KAACS;QACCC,KAAKrC;QACLX,WAAWzB,WAAWgB,MAAM,CAAC,UAAU,EAAEuD,yBAAyB9C;QACjE,GAAGK,KAAK;kBAERiC;;AAGP,EAAE"}